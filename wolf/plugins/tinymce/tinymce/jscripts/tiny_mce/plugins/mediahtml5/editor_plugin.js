(function(){var i=tinymce.each;tinymce.create('tinymce.plugins.MediaHtml5Plugin',{_parse:function(s){return tinymce.util.JSON.parse('{'+s+'}')},_serialize:function(o){return tinymce.util.JSON.serialize(o).replace(/[{}]/g,'')},_objectsToSpans:function(d,o){var t=this,h=o.content;h=h.replace(/<script[^>]*>\s*write(Video|Flash|ShockWave|WindowsMedia|QuickTime|RealMedia)\(\{([^\)]*)\}\);\s*<\/script>/gi,function(a,b,c){var o=t._parse(c);return'<img class="mceItem'+b+'" title="'+d.dom.encode(c)+'" src="'+t.url+'/img/trans.gif" width="'+o.width+'" height="'+o.height+'" />'});h=h.replace(/<object([^>]*)>/gi,'<span class="mceItemObject" $1>');h=h.replace(/<embed([^>]*)\/?>/gi,'<span class="mceItemEmbed" $1></span>');h=h.replace(/<embed([^>]*)>/gi,'<span class="mceItemEmbed" $1>');h=h.replace(/<\/(object)([^>]*)>/gi,'</span>');h=h.replace(/<\/embed>/gi,'');h=h.replace(/<param([^>]*)>/gi,function(a,b){return'<span '+b.replace(/value=/gi,'_mce_value=')+' class="mceItemParam"></span>'});h=h.replace(/\/ class=\"mceItemParam\"><\/span>/gi,'class="mceItemParam"></span>');h=h.replace(/<video([^>]*)>/gi,'<span class="mceItemVideoTag" $1>');h=h.replace(/<\/(video)([^>]*)>/gi,'</span>');h=h.replace(/<source([^>]*)>/gi,function(a,b){return'<span '+b.replace(/value=/gi,'_mce_value=')+' class="mceItemVideoSourceTag"></span>'});h=h.replace(/\/ class=\"mceItemVideoSourceTag\"><\/span>/gi,'class="mceItemVideoSourceTag"></span>');h=h.replace(/<\/source>/gi,'');o.content=h},_buildVideoObj:function(o,n){var a,ed=this.editor,dom=ed.dom,p=this._parse(n.title),s,ss;p.width=o.width=dom.getAttrib(n,'width')||100;p.height=o.height=dom.getAttrib(n,'height')||100;s={_mce_name:'video',style:dom.getAttrib(n,'style'),width:o.width,height:o.height};if(typeof p.id!=="undefined"&&p.id>0){s.id=p.id}if(typeof p.title!=="undefined"&&p.title.length>0){s.title=p.title}if(typeof p.poster!=="undefined"&&p.poster.length>0){s.poster=p.poster}if(typeof p.showcontrols!=="undefined"){s.controls='controls'}if(typeof p.autoplay!=="undefined"){s.autoplay='autoplay'}if(typeof p.loop==="boolean"){s.loop=p.loop}if(typeof p.preload!=="undefined"){s.preload='auto'}if(typeof p.buffer!=="undefined"){s.autobuffer='autobuffer'}a=dom.create('span',s);ss={_mce_name:'source'};i(p,function(v,k){if(/^(src|mimetype|media)$/.test(k)){if(k==='src'&&k.length>0){ss.src=v}if(k==='mimetype'&&k.length>0){ss.type=v}if(k==='media'&&k.length>0){ss.media=v}}});dom.add(a,'span',ss);return a},_buildObj:function(o,n){var a,ed=this.editor,dom=ed.dom,p=this._parse(n.title),stc;stc=ed.getParam('media_strict',true)&&o.type==='application/x-shockwave-flash';p.width=o.width=dom.getAttrib(n,'width')||100;p.height=o.height=dom.getAttrib(n,'height')||100;if(p.src){p.src=ed.convertURL(p.src,'src',n)}if(stc){a=dom.create('span',{id:p.id,_mce_name:'object',type:'application/x-shockwave-flash',data:p.src,style:dom.getAttrib(n,'style'),width:o.width,height:o.height})}else{a=dom.create('span',{id:p.id,_mce_name:'object',classid:"clsid:"+o.classid,style:dom.getAttrib(n,'style'),codebase:o.codebase,width:o.width,height:o.height})}i(p,function(v,k){if(!/^(width|height|codebase|classid|id|_cx|_cy)$/.test(k)){if(o.type==='application/x-mplayer2'&&k==='src'&&!p.url){k='url'}if(v){dom.add(a,'span',{_mce_name:'param',name:k,'_mce_value':v})}}});if(!stc){dom.add(a,'span',tinymce.extend({_mce_name:'embed',type:o.type,style:dom.getAttrib(n,'style')},p))}return a},_createImg:function(b,n){var c,dom=this.editor.dom,pa={},args;args=['id','name','width','height','bgcolor','align','flashvars','src','wmode','allowfullscreen','quality','data','title','poster','autoplay','autobuffer','controls','loop','preload','media','type'];c=dom.create('img',{src:this.url+'/img/trans.gif',width:dom.getAttrib(n,'width')||100,height:dom.getAttrib(n,'height')||100,style:dom.getAttrib(n,'style'),'class':b});i(args,function(a){var v=dom.getAttrib(n,a);if(typeof v==="string"&&v.length>0){pa[a]=v}});i(dom.select('span',n),function(n){if(dom.hasClass(n,'mceItemParam')||dom.hasClass(n,'mceItemVideoSourceTag')){pa[dom.getAttrib(n,'name')]=dom.getAttrib(n,'_mce_value')}});if(pa.movie){pa.src=pa.movie;delete pa.movie}if(!pa.src&&typeof pa.data!=="undefined"){pa.src=pa.data;delete pa.data}if(typeof pa.poster==="string"&&pa.poster.length>0&&(/\/img\/trans\.gif/).test(c.src)){c.src=pa.poster}n=dom.select('.mceItemEmbed',n)[0];if(n){i(args,function(a){var v=dom.getAttrib(n,a);if(v&&!pa[a]){pa[a]=v}})}n=dom.select('.mceItemVideoSourceTag',n)[0];if(n){i(args,function(a){var v=dom.getAttrib(n,a);if(v&&!pa[a]){pa[a]=v}})}delete pa.width;delete pa.height;c.title=this._serialize(pa);return c},_spansToImgs:function(p){var t=this,dom=t.editor.dom,ci;i(dom.select('span',p),function(n){if(dom.getAttrib(n,'class')==='mceItemObject'){ci=dom.getAttrib(n,"classid").toLowerCase().replace(/\s+/g,'');switch(ci){case'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000':dom.replace(t._createImg('mceItemFlash',n),n);break;case'clsid:166b1bca-3f9c-11cf-8075-444553540000':dom.replace(t._createImg('mceItemShockWave',n),n);break;case'clsid:6bf52a52-394a-11d3-b153-00c04f79faa6':case'clsid:22d6f312-b0f6-11d0-94ab-0080c74c7e95':case'clsid:05589fa1-c356-11ce-bf01-00aa0055595a':dom.replace(t._createImg('mceItemWindowsMedia',n),n);break;case'clsid:02bf25d5-8c17-4b23-bc80-d3488abddc6b':dom.replace(t._createImg('mceItemQuickTime',n),n);break;case'clsid:cfcdaa03-8be4-11cf-b84b-0020afbbccfa':dom.replace(t._createImg('mceItemRealMedia',n),n);break;default:dom.replace(t._createImg('mceItemFlash',n),n)}return}if(dom.getAttrib(n,'class')==='mceItemEmbed'){switch(dom.getAttrib(n,'type')){case'application/x-shockwave-flash':dom.replace(t._createImg('mceItemFlash',n),n);break;case'application/x-director':dom.replace(t._createImg('mceItemShockWave',n),n);break;case'application/x-mplayer2':dom.replace(t._createImg('mceItemWindowsMedia',n),n);break;case'video/quicktime':dom.replace(t._createImg('mceItemQuickTime',n),n);break;case'audio/x-pn-realaudio-plugin':dom.replace(t._createImg('mceItemRealMedia',n),n);break;default:dom.replace(t._createImg('mceItemFlash',n),n)}}if(dom.getAttrib(n,'class')==='mceItemVideoTag'){dom.replace(t._createImg('mceItemVideo',n),n)}if(dom.getAttrib(n,'class')==='mceItemVideoSourceTag'){dom.replace(t._createImg('mceItemVideo',n),n)}})},init:function(f,g){var t=this;t.editor=f;t.url=g;function isMediaHtml5Elm(n){return(/^(mceItemVideo|mceItemFlash|mceItemShockWave|mceItemWindowsMedia|mceItemQuickTime|mceItemRealMedia)$/).test(n.className)}f.onPreInit.add(function(){f.serializer.addRules('param[name|value|_mce_value],video[poster|title|autoplay|controls|height|loop|preload|src|width],source[src|type|media]')});f.addCommand('mceMediaHtml5',function(){f.windowManager.open({file:g+'/mediahtml5.htm',width:430+parseInt(f.getLang('media.delta_width',0),10),height:470+parseInt(f.getLang('media.delta_height',0),10),inline:1},{plugin_url:g})});f.addButton('mediahtml5',{title:'Insert / edit embedded media',image:g+'/img/mediahtml5.png',cmd:'mceMediaHtml5'});f.onNodeChange.add(function(a,b,n){b.setActive('mediahtml5',n.nodeName==='IMG'&&isMediaHtml5Elm(n))});f.onInit.add(function(){var b={mceItemVideo:'video',mceItemFlash:'flash',mceItemShockWave:'shockwave',mceItemWindowsMedia:'windowsmedia',mceItemQuickTime:'quicktime',mceItemRealMedia:'realmedia'};f.selection.onSetContent.add(function(){t._spansToImgs(f.getBody())});f.selection.onBeforeSetContent.add(t._objectsToSpans,t);if(f.settings.content_css!==false){f.dom.loadCSS(g+"/css/content.css")}if(f.theme&&f.theme.onResolveName){f.theme.onResolveName.add(function(a,o){if(o.name==='img'){i(b,function(v,k){if(f.dom.hasClass(o.node,k)){o.name=v;o.title=f.dom.getAttrib(o.node,'title');return false}})}})}if(f&&f.plugins.contextmenu){f.plugins.contextmenu.onContextMenu.add(function(a,m,e){if(e.nodeName==='IMG'&&/mceItem(Video|Flash|ShockWave|WindowsMedia|QuickTime|RealMedia)/.test(e.className)){m.add({title:'mediahtml5.edit',icon:g+'/img/mediahtml5.png',image:g+'/img/mediahtml5.png',cmd:'mceMediaHtml5'})}})}});f.onBeforeSetContent.add(t._objectsToSpans,t);f.onSetContent.add(function(){t._spansToImgs(f.getBody())});f.onPreProcess.add(function(b,o){var c=b.dom;if(o.set){t._spansToImgs(o.node);i(c.select('IMG',o.node),function(n){var p;if(isMediaHtml5Elm(n)){p=t._parse(n.title);c.setAttrib(n,'width',c.getAttrib(n,'width',p.width||100));c.setAttrib(n,'height',c.getAttrib(n,'height',p.height||100))}})}if(o.get){i(c.select('IMG',o.node),function(n){var a,cb,mt;if(b.getParam('media_use_script')){if(isMediaHtml5Elm(n)){n.className=n.className.replace(/mceItem/g,'mceTemp')}return}switch(n.className){case'mceItemVideo':a='';cb='';mt='';break;case'mceItemFlash':a='d27cdb6e-ae6d-11cf-96b8-444553540000';cb='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0';mt='application/x-shockwave-flash';break;case'mceItemShockWave':a='166b1bca-3f9c-11cf-8075-444553540000';cb='http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0';mt='application/x-director';break;case'mceItemWindowsMedia':a=b.getParam('media_wmp6_compatible')?'05589fa1-c356-11ce-bf01-00aa0055595a':'6bf52a52-394a-11d3-b153-00c04f79faa6';cb='http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701';mt='application/x-mplayer2';break;case'mceItemQuickTime':a='02bf25d5-8c17-4b23-bc80-d3488abddc6b';cb='http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0';mt='video/quicktime';break;case'mceItemRealMedia':a='cfcdaa03-8be4-11cf-b84b-0020afbbccfa';cb='http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0';mt='audio/x-pn-realaudio-plugin';break}if(a.length>0){c.replace(t._buildObj({classid:a,codebase:cb,type:mt},n),n)}else{c.replace(t._buildVideoObj({type:''},n),n)}})}});f.onPostProcess.add(function(a,o){o.content=o.content.replace(/_mce_value=/g,'value=')});function getAttr(s,n){n=new RegExp(n+'=\"([^\"]+)\"','g').exec(s);return n?f.dom.decode(n[1]):''}f.onPostProcess.add(function(d,o){if(d.getParam('media_use_script')){o.content=o.content.replace(/<img[^>]+>/g,function(a){var b=getAttr(a,'class');if(/^(mceTempVideo|mceTempFlash|mceTempShockWave|mceTempWindowsMedia|mceTempQuickTime|mceTempRealMedia)$/.test(b)){var c=t._parse(getAttr(a,'title'));c.width=getAttr(a,'width');c.height=getAttr(a,'height');a='<script type="text/javascript">write'+b.substring(7)+'({'+t._serialize(c)+'});</script>'}return a})}})},getInfo:function(){return{longname:'HTML5 Media Plug-In',author:'CJBoCo (Based on the "media" plug-in by Moxiecode Systems AB)',authorurl:'http://www.cjboco.com/',infourl:'http://www.cjboco.com/projects.cfm/project/tinymce-html5-media-plug-in/',version:'0.1'}}});tinymce.PluginManager.add('mediahtml5',tinymce.plugins.MediaHtml5Plugin)})();